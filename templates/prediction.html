{% extends "base.html" %} {% block title %}Predições ML - E-commerce Analytics{%
endblock %} {% block content %}
<div class="col-12">
  <div class="container-fluid mt-4">
    <div class="row">
      <div class="col-12">
        <h2 class="mb-1">
          <i class="fas fa-brain me-2 text-warning"></i>
          Predições E-commerce com Machine Learning
        </h2>
        <p class="text-muted">
          Configure algoritmos para predizer comportamento de clientes e
          satisfação
        </p>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-cogs me-2"></i>
              Configuração do Modelo
            </h5>
          </div>
          <div class="card-body">
            <form id="trainingForm">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="problemType" class="form-label"
                    >Tipo de Problema</label
                  >
                  <select
                    class="form-select"
                    id="problemType"
                    onchange="updateAlgorithms()"
                  >
                    <option value="classification">Classificação</option>
                    <option value="regression">Regressão</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="algorithm" class="form-label">Algoritmo</label>
                  <select class="form-select" id="algorithm">
                    <option value="logistic_regression">
                      Logistic Regression
                    </option>
                    <option value="random_forest">
                      Random Forest Classifier
                    </option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="targetVariable" class="form-label"
                    >Variável Alvo</label
                  >
                  <select class="form-select" id="targetVariable" disabled>
                    <option value="">Carregando colunas...</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="testSize" class="form-label"
                    >Tamanho do Conjunto de Teste (%)</label
                  >
                  <input
                    type="range"
                    class="form-range"
                    id="testSize"
                    min="10"
                    max="50"
                    value="20"
                    onchange="updateTestSize(this.value)"
                  />
                  <small class="text-muted"
                    >Valor: <span id="testSizeValue">20%</span></small
                  >
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label"
                    >Parâmetros do Modelo (Opcional)</label
                  >
                  <div class="border p-3 rounded">
                    <div class="mb-2">
                      <label for="nEstimators" class="form-label small"
                        >Número de Estimadores (Random Forest)</label
                      >
                      <input
                        type="number"
                        class="form-control form-control-sm"
                        id="nEstimators"
                        min="10"
                        max="500"
                        value="100"
                        placeholder="100"
                      />
                    </div>
                    <div class="mb-2">
                      <label for="maxDepth" class="form-label small"
                        >Profundidade Máxima (Random Forest)</label
                      >
                      <input
                        type="number"
                        class="form-control form-control-sm"
                        id="maxDepth"
                        min="1"
                        max="50"
                        placeholder="Sem limite"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-12">
                  <button
                    type="button"
                    class="btn btn-warning btn-lg"
                    onclick="trainModel()"
                    id="trainBtn"
                  >
                    <i class="fas fa-play me-2"></i>
                    Treinar Modelo
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-chart-line me-2"></i>
              Performance do Modelo
            </h5>
          </div>
          <div class="card-body">
            <div id="metricsContainer">
              <div class="text-center text-muted py-5">
                <i class="fas fa-chart-line fa-3x mb-3"></i>
                <p>Treine um modelo para ver as métricas aqui</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-info-circle me-2"></i>
              Informações do Modelo
            </h5>
          </div>
          <div class="card-body">
            <div id="modelInfoContainer">
              <div class="text-center text-muted py-5">
                <i class="fas fa-info-circle fa-3x mb-3"></i>
                <p>Informações do modelo aparecerão aqui após o treinamento</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4" id="resultsRow" style="display: none">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-chart-bar me-2"></i>
              Resultados e Predições
            </h5>
          </div>
          <div class="card-body">
            <div id="resultsContainer">
              <!-- Resultados serão inseridos aqui -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Seção de Predição Individual -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card" id="individualPredictionCard" style="display: none">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-calculator me-2"></i>
              Predição Individual
            </h5>
          </div>
          <div class="card-body">
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              Preencha os valores das features abaixo para obter uma predição do
              modelo treinado.
            </div>

            <div id="predictionFormContainer">
              <p class="text-muted">
                Treine um modelo primeiro para ver os campos de predição.
              </p>
            </div>

            <div class="mt-3">
              <button
                type="button"
                class="btn btn-primary"
                onclick="makePrediction()"
                id="predictBtn"
                disabled
              >
                <i class="fas fa-magic me-2"></i>
                Fazer Predição
              </button>
            </div>

            <div id="predictionResult" class="mt-4" style="display: none"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  // Variáveis globais
  let currentModelId = null;
  let currentModelType = null;
  let modelFeatures = null;
  let availableColumns = [];

  // URLs das APIs backend
  const API_BASE_URL = window.location.origin;

  // Carrega colunas do dataset
  async function loadColumns() {
    try {
      const response = await fetch(`${API_BASE_URL}/columns`);

      if (!response.ok) {
        throw new Error("Erro ao obter colunas");
      }

      const data = await response.json();
      availableColumns = data.columns || [];

      updateTargetOptions();
    } catch (error) {
      console.error("Erro ao carregar colunas:", error);
      showNotification("Erro ao carregar colunas: " + error.message, "error");
    }
  }

  // Atualiza opções de variável alvo
  function updateTargetOptions() {
    const problemType = document.getElementById("problemType").value;
    const targetSelect = document.getElementById("targetVariable");

    targetSelect.disabled = false;
    targetSelect.innerHTML = "";

    // Filtra colunas baseado no tipo de problema
    if (problemType === "regression") {
      // Para regressão, mostra colunas numéricas
      const numericOptions = availableColumns.filter((col) =>
        [
          "total_amount",
          "age",
          "session_duration",
          "pages_viewed",
          "delivery_time",
          "discount_amount",
        ].includes(col)
      );

      numericOptions.forEach((col) => {
        const option = document.createElement("option");
        option.value = col;
        option.textContent = col;
        targetSelect.appendChild(option);
      });

      if (numericOptions.includes("total_amount")) {
        targetSelect.value = "total_amount";
      }
    } else {
      // Para classificação, mostra colunas categóricas
      const categoricalOptions = availableColumns.filter((col) =>
        [
          "customer_rating",
          "product_category",
          "gender",
          "device_type",
          "payment_method",
        ].includes(col)
      );

      categoricalOptions.forEach((col) => {
        const option = document.createElement("option");
        option.value = col;
        option.textContent = col;
        targetSelect.appendChild(option);
      });

      if (categoricalOptions.includes("customer_rating")) {
        targetSelect.value = "customer_rating";
      }
    }
  }

  // Atualiza algoritmos disponíveis
  function updateAlgorithms() {
    const problemType = document.getElementById("problemType").value;
    const algorithmSelect = document.getElementById("algorithm");

    algorithmSelect.innerHTML = "";

    if (problemType === "classification") {
      algorithmSelect.innerHTML = `
        <option value="logistic_regression">Logistic Regression</option>
        <option value="random_forest">Random Forest Classifier</option>
      `;
    } else {
      algorithmSelect.innerHTML = `
        <option value="linear_regression">Linear Regression</option>
        <option value="random_forest_reg">Random Forest Regressor</option>
      `;
    }

    updateTargetOptions();
  }

  function updateTestSize(value) {
    document.getElementById("testSizeValue").textContent = value + "%";
  }

  // Treina o modelo
  async function trainModel() {
    const problemType = document.getElementById("problemType").value;
    const algorithm = document.getElementById("algorithm").value;
    const targetCol = document.getElementById("targetVariable").value;
    const testSize =
      parseFloat(document.getElementById("testSize").value) / 100;
    const trainBtn = document.getElementById("trainBtn");

    if (!targetCol) {
      showNotification("Por favor, selecione uma variável alvo", "error");
      return;
    }

    try {
      trainBtn.disabled = true;
      trainBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin me-2"></i>Treinando...';

      showNotification("Iniciando treinamento do modelo...", "info");

      const modelType =
        problemType === "regression" ? "regression" : "classification";

      // Coleta parâmetros opcionais
      const params = {};
      const nEstimators = document.getElementById("nEstimators").value;
      const maxDepth = document.getElementById("maxDepth").value;

      if (
        nEstimators &&
        (algorithm === "random_forest" || algorithm === "random_forest_reg")
      ) {
        params.n_estimators = parseInt(nEstimators);
      }
      if (
        maxDepth &&
        maxDepth.trim() !== "" &&
        (algorithm === "random_forest" || algorithm === "random_forest_reg")
      ) {
        const depth = parseInt(maxDepth);
        if (!isNaN(depth) && depth > 0) {
          params.max_depth = depth;
        }
      }

      const config = {
        model_type: modelType,
        target_col: targetCol,
        algorithm: algorithm,
        test_size: testSize,
        random_state: 42,
      };

      if (Object.keys(params).length > 0) {
        config.params = params;
      }

      const response = await fetch(`${API_BASE_URL}/train`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(config),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || "Erro ao treinar modelo");
      }

      const data = await response.json();
      currentModelId = data.model.model_id;
      currentModelType = modelType;

      // Atualiza métricas na interface
      const metrics = data.model.metrics || {};
      if (modelType === "classification") {
        updateClassificationMetrics(metrics);
        updateClassificationResults(data.model);
      } else {
        updateRegressionMetrics(metrics);
        updateRegressionResults(data.model);
      }

      updateModelInfo(data.model);
      document.getElementById("resultsRow").style.display = "block";

      // Carrega formulário de predição
      if (data.model.model_id) {
        loadPredictionForm(data.model.model_id, modelType);
      }

      showNotification("Modelo treinado com sucesso!", "success");
    } catch (error) {
      showNotification("Erro ao treinar modelo: " + error.message, "error");
      console.error("Erro:", error);
    } finally {
      trainBtn.disabled = false;
      trainBtn.innerHTML = '<i class="fas fa-play me-2"></i>Treinar Modelo';
    }
  }

  function updateClassificationMetrics(metrics) {
    const container = document.getElementById("metricsContainer");
    container.innerHTML = `
      <div class="row text-center">
        <div class="col-4">
          <h4 class="text-primary">${(metrics.accuracy * 100).toFixed(2)}%</h4>
          <small class="text-muted">Accuracy</small>
        </div>
        <div class="col-4">
          <h4 class="text-success">${(metrics.precision * 100).toFixed(2)}%</h4>
          <small class="text-muted">Precision</small>
        </div>
        <div class="col-4">
          <h4 class="text-info">${(metrics.recall * 100).toFixed(2)}%</h4>
          <small class="text-muted">Recall</small>
        </div>
      </div>
      <div class="row text-center mt-3">
        <div class="col-6">
          <h5 class="text-warning">${(metrics.f1 * 100).toFixed(2)}%</h5>
          <small class="text-muted">F1-Score</small>
        </div>
        <div class="col-6">
          <h5 class="text-secondary">${metrics.n_classes || 2}</h5>
          <small class="text-muted">Classes</small>
        </div>
      </div>
    `;
  }

  function updateRegressionMetrics(metrics) {
    const container = document.getElementById("metricsContainer");
    container.innerHTML = `
      <div class="row text-center">
        <div class="col-4">
          <h4 class="text-primary">${(metrics.r2 * 100).toFixed(2)}%</h4>
          <small class="text-muted">R² Score</small>
        </div>
        <div class="col-4">
          <h4 class="text-success">${metrics.mae.toFixed(2)}</h4>
          <small class="text-muted">MAE</small>
        </div>
        <div class="col-4">
          <h4 class="text-info">${metrics.rmse.toFixed(2)}</h4>
          <small class="text-muted">RMSE</small>
        </div>
      </div>
    `;
  }

  function updateModelInfo(model) {
    const container = document.getElementById("modelInfoContainer");
    const algorithm = model.algorithm || "N/A";
    const targetCol = model.target_col || "N/A";
    const nTrain = model.n_samples_train || 0;
    const nTest = model.n_samples_test || 0;
    const numericFeatures = model.numeric_features
      ? model.numeric_features.length
      : 0;
    const categoricalFeatures = model.categorical_features
      ? model.categorical_features.length
      : 0;

    container.innerHTML = `
      <div class="mb-3">
        <strong>Algoritmo:</strong> ${algorithm}
      </div>
      <div class="mb-3">
        <strong>Variável Alvo:</strong> ${targetCol}
      </div>
      <div class="mb-3">
        <strong>Amostras de Treino:</strong> ${nTrain}
      </div>
      <div class="mb-3">
        <strong>Amostras de Teste:</strong> ${nTest}
      </div>
      <div class="mb-3">
        <strong>Features Numéricas:</strong> ${numericFeatures}
      </div>
      <div class="mb-3">
        <strong>Features Categóricas:</strong> ${categoricalFeatures}
      </div>
      <div class="mb-3">
        <strong>Model ID:</strong> <small class="text-muted">${
          model.model_id || "N/A"
        }</small>
      </div>
    `;
  }

  function updateClassificationResults(model) {
    const container = document.getElementById("resultsContainer");
    const yTest = model.y_test_sample || [];
    const yPred = model.y_pred_sample || [];

    if (yTest.length === 0 || yPred.length === 0) {
      container.innerHTML =
        '<p class="text-muted">Nenhum resultado de exemplo disponível.</p>';
      return;
    }

    let tableHtml = `
      <h6 class="mb-3">Predições de Exemplo (Primeiras ${yTest.length} amostras)</h6>
      <div class="table-responsive mb-4">
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th>#</th>
              <th>Classe Real</th>
              <th>Classe Prevista</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
    `;

    yTest.forEach((real, idx) => {
      const pred = yPred[idx];
      const isCorrect = real === pred;

      tableHtml += `
        <tr class="${isCorrect ? "table-success" : "table-danger"}">
          <td>${idx + 1}</td>
          <td>${real}</td>
          <td>${pred}</td>
          <td>${isCorrect ? "Correto" : "Incorreto"}</td>
        </tr>
      `;
    });

    tableHtml += "</tbody></table></div>";
    container.innerHTML = tableHtml;
  }

  function updateRegressionResults(model) {
    const container = document.getElementById("resultsContainer");
    const yTest = model.y_test_sample || [];
    const yPred = model.y_pred_sample || [];

    if (yTest.length === 0 || yPred.length === 0) {
      container.innerHTML =
        '<p class="text-muted">Nenhum resultado de exemplo disponível.</p>';
      return;
    }

    let tableHtml = `
      <h6 class="mb-3">Predições de Exemplo (Primeiras ${yTest.length} amostras)</h6>
      <div class="table-responsive">
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th>#</th>
              <th>Valor Real</th>
              <th>Valor Previsto</th>
              <th>Erro</th>
            </tr>
          </thead>
          <tbody>
    `;

    yTest.forEach((real, idx) => {
      const pred = yPred[idx] || 0;
      const error = Math.abs(real - pred);
      const errorPercent =
        real !== 0 ? ((error / Math.abs(real)) * 100).toFixed(2) : "N/A";

      tableHtml += `
        <tr>
          <td>${idx + 1}</td>
          <td>${real.toFixed(2)}</td>
          <td>${pred.toFixed(2)}</td>
          <td>${error.toFixed(2)} (${errorPercent}%)</td>
        </tr>
      `;
    });

    tableHtml += "</tbody></table></div>";
    container.innerHTML = tableHtml;
  }

  async function loadPredictionForm(modelId, modelType) {
    currentModelId = modelId;
    currentModelType = modelType;

    try {
      let url = `${API_BASE_URL}/models/${modelId}/features`;
      if (modelType) {
        url += `?model_type=${modelType}`;
      }

      const response = await fetch(url);
      if (!response.ok) {
        throw new Error("Erro ao obter features do modelo");
      }

      const featuresData = await response.json();
      modelFeatures = featuresData;

      const container = document.getElementById("predictionFormContainer");
      const card = document.getElementById("individualPredictionCard");

      if (
        !featuresData.all_features ||
        featuresData.all_features.length === 0
      ) {
        container.innerHTML =
          '<p class="text-danger">Nenhuma feature encontrada no modelo.</p>';
        return;
      }

      let formHtml = '<div class="row">';

      featuresData.numeric_features.forEach((feature) => {
        formHtml += `
          <div class="col-md-6 mb-3">
            <label for="pred_${feature}" class="form-label">${feature} <span class="text-muted">(numérico)</span></label>
            <input type="number" class="form-control" id="pred_${feature}" step="any" placeholder="Digite um valor numérico">
          </div>
        `;
      });

      featuresData.categorical_features.forEach((feature) => {
        formHtml += `
          <div class="col-md-6 mb-3">
            <label for="pred_${feature}" class="form-label">${feature} <span class="text-muted">(categórico)</span></label>
            <input type="text" class="form-control" id="pred_${feature}" placeholder="Digite um valor categórico">
          </div>
        `;
      });

      formHtml += "</div>";
      container.innerHTML = formHtml;

      card.style.display = "block";
      document.getElementById("predictBtn").disabled = false;
    } catch (error) {
      console.error("Erro ao carregar features:", error);
      showNotification(
        "Erro ao carregar features do modelo: " + error.message,
        "error"
      );
    }
  }

  async function makePrediction() {
    if (!currentModelId || !currentModelType || !modelFeatures) {
      showNotification("Nenhum modelo carregado para predição.", "error");
      return;
    }

    const features = {};
    let hasEmptyFields = false;

    modelFeatures.all_features.forEach((feature) => {
      const input = document.getElementById(`pred_${feature}`);
      if (input) {
        const value = input.value.trim();
        if (value === "") {
          hasEmptyFields = true;
        } else {
          if (modelFeatures.numeric_features.includes(feature)) {
            const normalizedValue = value.replace(",", ".");
            features[feature] = parseFloat(normalizedValue);
            if (isNaN(features[feature])) {
              hasEmptyFields = true;
            }
          } else {
            features[feature] = value;
          }
        }
      }
    });

    if (hasEmptyFields) {
      showNotification(
        "Por favor, preencha todos os campos antes de fazer a predição.",
        "error"
      );
      return;
    }

    try {
      const predictBtn = document.getElementById("predictBtn");
      predictBtn.disabled = true;
      predictBtn.innerHTML =
        '<span class="spinner-border spinner-border-sm me-2"></span>Calculando...';

      const response = await fetch(`${API_BASE_URL}/predict`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model_id: currentModelId,
          model_type: currentModelType,
          features: features,
        }),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || "Erro ao fazer predição");
      }

      const result = await response.json();

      const resultContainer = document.getElementById("predictionResult");
      resultContainer.style.display = "block";

      if (currentModelType === "classification") {
        const predictedLabel =
          result.prediction || result.y_pred_labels?.[0] || "N/A";
        const confidence =
          result.confidence ||
          (result.y_proba ? Math.max(...result.y_proba) : 0);

        resultContainer.innerHTML = `
          <div class="alert alert-success">
            <h6><i class="fas fa-check-circle me-2"></i>Predição Realizada com Sucesso!</h6>
            <hr>
            <p class="mb-0"><strong>Classe Prevista:</strong> <span class="h4 text-success">${predictedLabel}</span></p>
            <p class="mb-0"><strong>Confiança:</strong> <span class="h5">${(
              confidence * 100
            ).toFixed(2)}%</span></p>
            <small class="text-muted d-block mt-2">Modelo: ${currentModelId}</small>
          </div>
        `;
      } else {
        const prediction = result.prediction || result.y_pred?.[0] || 0;

        resultContainer.innerHTML = `
          <div class="alert alert-success">
            <h6><i class="fas fa-check-circle me-2"></i>Predição Realizada com Sucesso!</h6>
            <hr>
            <p class="mb-0"><strong>Valor Previsto:</strong> <span class="h4 text-success">${prediction.toFixed(
              2
            )}</span></p>
            <small class="text-muted d-block mt-2">Modelo: ${currentModelId}</small>
          </div>
        `;
      }
    } catch (error) {
      console.error("Erro ao fazer predição:", error);
      showNotification("Erro ao fazer predição: " + error.message, "error");
      document.getElementById("predictionResult").style.display = "none";
    } finally {
      const predictBtn = document.getElementById("predictBtn");
      predictBtn.disabled = false;
      predictBtn.innerHTML = '<i class="fas fa-magic me-2"></i>Fazer Predição';
    }
  }

  function showNotification(message, type = "info") {
    const notification = document.createElement("div");
    notification.className = `alert alert-${
      type === "error" ? "danger" : type === "success" ? "success" : "info"
    } alert-dismissible fade show`;
    notification.style.position = "fixed";
    notification.style.top = "20px";
    notification.style.right = "20px";
    notification.style.zIndex = "9999";
    notification.style.minWidth = "300px";
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 5000);
  }

  // Inicialização
  document.addEventListener("DOMContentLoaded", function () {
    loadColumns();
    updateAlgorithms();
  });
</script>
{% endblock %}
