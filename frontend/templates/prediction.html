{% extends "base.html" %}

{% block title %}Predições ML - E-commerce Analytics{% endblock %}

{% block content %}
<div class="col-12">
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-1">
                    <i class="fas fa-brain me-2 text-warning"></i>
                    Predições E-commerce com Machine Learning
                </h2>
                <p class="text-muted">Configure algoritmos para predizer comportamento de clientes e satisfação</p>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            Configuração do Modelo
                        </h5>
                    </div>
                    <div class="card-body">
                        <form>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="problemType" class="form-label">Tipo de Problema</label>
                                    <select class="form-select" id="problemType" onchange="updateAlgorithms()">
                                        <option value="classification">Classificação</option>
                                        <option value="regression">Regressão</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="algorithm" class="form-label">Algoritmo</label>
                                    <select class="form-select" id="algorithm">
                                        <option value="logistic_regression">Logistic Regression</option>
                                        <option value="random_forest">Random Forest Classifier</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="targetVariable" class="form-label">Variável Alvo</label>
                                    <select class="form-select" id="targetVariable" disabled>
                                        <option value="">Selecione o tipo de problema primeiro</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Regressão: total_amount | Classificação: is_returning_customer
                                    </small>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="testSize" class="form-label">Tamanho do Conjunto de Teste (%)</label>
                      <input
                        type="range"
                        class="form-range"
                        id="testSize"
                        min="10"
                        max="50"
                        value="20"
                        onchange="updateTestSize(this.value)"
                      />
                                    <small class="text-muted">Valor: <span id="testSizeValue">20%</span></small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Parâmetros do Modelo (Opcional)</label>
                                    <div class="border p-3 rounded">
                                        <div class="mb-2">
                                            <label for="nEstimators" class="form-label small">Número de Estimadores (Random Forest)</label>
                                            <input type="number" class="form-control form-control-sm" id="nEstimators" min="10" max="500" value="100" placeholder="100">
                    </div>
                    <div class="mb-2">
                                            <label for="maxDepth" class="form-label small">Profundidade Máxima (Random Forest)</label>
                                            <input type="number" class="form-control form-control-sm" id="maxDepth" min="1" max="50" placeholder="Sem limite">
                    </div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-12">
                  <button
                    type="button"
                    class="btn btn-warning btn-lg"
                    onclick="trainModel()"
                                        id="trainBtn"
                  >
                    <i class="fas fa-play me-2"></i>
                    Treinar Modelo
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-chart-line me-2"></i>
              Performance do Modelo
            </h5>
          </div>
          <div class="card-body">
                        <div id="metricsContainer">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-chart-line fa-3x mb-3"></i>
                                <p>Treine um modelo para ver as métricas aqui</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Informações do Modelo
            </h5>
          </div>
          <div class="card-body">
                        <div id="modelInfoContainer">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-info-circle fa-3x mb-3"></i>
                                <p>Informações do modelo aparecerão aqui após o treinamento</p>
                            </div>
              </div>
          </div>
        </div>
      </div>
    </div>

        <div class="row mb-4" id="resultsRow" style="display: none;">
            <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Resultados e Predições
            </h5>
          </div>
          <div class="card-body">
                        <div id="resultsContainer">
                            <!-- Resultados serão inseridos aqui -->
              </div>
            </div>
          </div>
        </div>
      </div>

    <!-- Seção de Predição Individual -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card" id="individualPredictionCard" style="display: none;">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-calculator me-2"></i>
              Predição Individual
            </h5>
          </div>
          <div class="card-body">
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              Preencha os valores das features abaixo para obter uma predição do modelo treinado.
            </div>
            
            <div id="predictionFormContainer">
              <p class="text-muted">Carregue um modelo treinado para ver os campos de predição.</p>
            </div>
            
            <div class="mt-3">
              <button type="button" class="btn btn-primary" onclick="makePrediction()" id="predictBtn" disabled>
                <i class="fas fa-magic me-2"></i>
                Fazer Predição
              </button>
            </div>
            
            <div id="predictionResult" class="mt-4" style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Variáveis globais
  let currentModelId = null;
  let currentModelType = null;
  let modelFeatures = null;
  let availableColumns = [];
  let numericColumns = [];
  let categoricalColumns = [];

  // Carrega colunas ao carregar a página
  async function loadColumns() {
    try {
      const response = await API.getColumns();
      availableColumns = response.columns || [];
      numericColumns = response.numeric_columns || [];
      categoricalColumns = response.categorical_columns || [];
      
      // Atualiza o select de variável alvo baseado no tipo de problema
      updateTargetOptions();
    } catch (error) {
      console.error('Erro ao carregar colunas:', error);
      showNotification('Erro ao carregar colunas: ' + error.message, 'error');
    }
  }

  // Atualiza opções de variável alvo baseado no tipo de problema
  function updateTargetOptions() {
    const problemType = document.getElementById("problemType").value;
    const targetSelect = document.getElementById("targetVariable");
    
    if (!targetSelect) return;
    
    // Habilita o select
    targetSelect.disabled = false;
    
    // Apenas duas opções fixas conforme solicitado
    if (problemType === "regression") {
      // Para regressão: apenas total_amount
      targetSelect.innerHTML = '<option value="total_amount">total_amount</option>';
      targetSelect.value = 'total_amount'; // Seleciona automaticamente
    } else if (problemType === "classification") {
      // Para classificação: apenas is_returning_customer (customer_type não existe no dataset)
      targetSelect.innerHTML = '<option value="is_returning_customer">is_returning_customer</option>';
      targetSelect.value = 'is_returning_customer'; // Seleciona automaticamente
    } else {
      targetSelect.innerHTML = '<option value="">Selecione o tipo de problema</option>';
      targetSelect.disabled = true;
    }
  }

  // Carrega modelos treinados
  async function loadModels() {
    try {
      const response = await API.listModels();
      const models = response.models || [];
      console.log('Modelos disponíveis:', models.length);
    } catch (error) {
      console.error('Erro ao carregar modelos:', error);
    }
  }

  // Atualiza algoritmos disponíveis baseado no tipo de problema
  function updateAlgorithms() {
    const problemType = document.getElementById("problemType").value;
    const algorithmSelect = document.getElementById("algorithm");

    algorithmSelect.innerHTML = "";

    if (problemType === "classification") {
      algorithmSelect.innerHTML = `
        <option value="logistic_regression">Logistic Regression</option>
        <option value="random_forest">Random Forest Classifier</option>
            `;
    } else if (problemType === "regression") {
      algorithmSelect.innerHTML = `
        <option value="linear_regression">Linear Regression</option>
                <option value="random_forest_reg">Random Forest Regressor</option>
      `;
    }
    
    // Atualiza também as opções de variável alvo
    updateTargetOptions();
  }

  function updateTestSize(value) {
    document.getElementById("testSizeValue").textContent = value + "%";
  }

  async function trainModel() {
    const problemType = document.getElementById("problemType").value;
    const algorithm = document.getElementById("algorithm").value;
    const targetCol = document.getElementById("targetVariable").value;
    const testSize = parseFloat(document.getElementById("testSize").value) / 100;
    const trainBtn = document.getElementById("trainBtn");
    
    if (!targetCol) {
      showNotification('Por favor, selecione uma variável alvo', 'error');
      return;
    }
    
    try {
      // Desabilita botão durante treinamento
      trainBtn.disabled = true;
      trainBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Treinando...';
      
      showNotification('Iniciando treinamento do modelo...', 'info');
      
      const modelType = problemType === 'regression' ? 'regression' : 'classification';
      
      // Coleta parâmetros opcionais
      const params = {};
      const nEstimators = document.getElementById("nEstimators").value;
      const maxDepth = document.getElementById("maxDepth").value;
      
      if (nEstimators && (algorithm === 'random_forest' || algorithm === 'random_forest_reg')) {
        params.n_estimators = parseInt(nEstimators);
      }
      if (maxDepth && maxDepth.trim() !== '' && (algorithm === 'random_forest' || algorithm === 'random_forest_reg')) {
        const depth = parseInt(maxDepth);
        if (!isNaN(depth) && depth > 0) {
          params.max_depth = depth;
        }
      }
      
      const config = {
        model_type: modelType,
        target_col: targetCol,
        algorithm: algorithm,
        test_size: testSize,
        random_state: 42
      };
      
      // Adiciona params apenas se houver algum
      if (Object.keys(params).length > 0) {
        config.params = params;
      }
      
      const response = await API.trainModel(config);
      currentModelId = response.model.model_id;
      currentModelType = modelType;
      
      // Atualiza métricas na interface
      const metrics = response.model.metrics || {};
      if (modelType === 'classification') {
        updateClassificationMetrics(metrics);
        updateClassificationResults(response.model);
      } else {
        updateRegressionMetrics(metrics);
        updateRegressionResults(response.model);
      }
      
      // Atualiza informações do modelo
      updateModelInfo(response.model);
      
      // Mostra seção de resultados
      document.getElementById('resultsRow').style.display = 'block';
      
      // Carrega formulário de predição individual apenas para classificação
      if (response.model.model_id && modelType === "classification") {
        loadPredictionForm(response.model.model_id, modelType);
      }
      
      showNotification('Modelo treinado com sucesso!', 'success');
      await loadModels();
    } catch (error) {
      showNotification('Erro ao treinar modelo: ' + error.message, 'error');
      console.error('Erro completo:', error);
    } finally {
      // Reabilita botão
      trainBtn.disabled = false;
      trainBtn.innerHTML = '<i class="fas fa-play me-2"></i>Treinar Modelo';
    }
  }

  function updateClassificationMetrics(metrics) {
    const container = document.getElementById("metricsContainer");
    container.innerHTML = `
      <div class="row text-center">
        <div class="col-4">
          <h4 class="text-primary">${(metrics.accuracy * 100).toFixed(2)}%</h4>
          <small class="text-muted">Accuracy</small>
        </div>
        <div class="col-4">
          <h4 class="text-success">${(metrics.precision * 100).toFixed(2)}%</h4>
          <small class="text-muted">Precision</small>
        </div>
        <div class="col-4">
          <h4 class="text-info">${(metrics.recall * 100).toFixed(2)}%</h4>
          <small class="text-muted">Recall</small>
        </div>
      </div>
      <div class="row text-center mt-3">
        <div class="col-6">
          <h5 class="text-warning">${(metrics.f1 * 100).toFixed(2)}%</h5>
          <small class="text-muted">F1-Score</small>
        </div>
        <div class="col-6">
          <h5 class="text-secondary">${metrics.n_classes || 2}</h5>
          <small class="text-muted">Classes</small>
        </div>
      </div>
    `;
  }

  function updateRegressionMetrics(metrics) {
    const container = document.getElementById("metricsContainer");
    container.innerHTML = `
      <div class="row text-center">
        <div class="col-4">
          <h4 class="text-primary">${(metrics.r2 * 100).toFixed(2)}%</h4>
          <small class="text-muted">R² Score</small>
        </div>
        <div class="col-4">
          <h4 class="text-success">${metrics.mae.toFixed(2)}</h4>
          <small class="text-muted">MAE</small>
        </div>
        <div class="col-4">
          <h4 class="text-info">${metrics.rmse.toFixed(2)}</h4>
          <small class="text-muted">RMSE</small>
        </div>
      </div>
    `;
  }

  function updateModelInfo(model) {
    const container = document.getElementById("modelInfoContainer");
    const algorithm = model.algorithm || 'N/A';
    const targetCol = model.target_col || 'N/A';
    const nTrain = model.n_samples_train || 0;
    const nTest = model.n_samples_test || 0;
    const numericFeatures = model.numeric_features ? model.numeric_features.length : 0;
    const categoricalFeatures = model.categorical_features ? model.categorical_features.length : 0;
    
    container.innerHTML = `
      <div class="mb-3">
        <strong>Algoritmo:</strong> ${algorithm}
      </div>
      <div class="mb-3">
        <strong>Variável Alvo:</strong> ${targetCol}
      </div>
      <div class="mb-3">
        <strong>Amostras de Treino:</strong> ${nTrain}
      </div>
      <div class="mb-3">
        <strong>Amostras de Teste:</strong> ${nTest}
      </div>
      <div class="mb-3">
        <strong>Features Numéricas:</strong> ${numericFeatures}
      </div>
      <div class="mb-3">
        <strong>Features Categóricas:</strong> ${categoricalFeatures}
      </div>
      <div class="mb-3">
        <strong>Model ID:</strong> <small class="text-muted">${model.model_id || 'N/A'}</small>
      </div>
    `;
  }

  function updateRegressionResults(model) {
    const container = document.getElementById("resultsContainer");
    const yTest = model.y_test_sample || [];
    const yPred = model.y_pred_sample || [];
    const targetCol = model.target_col || 'valor';
    
    if (yTest.length === 0 || yPred.length === 0) {
      container.innerHTML = '<p class="text-muted">Nenhum resultado de exemplo disponível.</p>';
      return;
    }
    
    // Cria tabela de predições
    let tableHtml = `
      <h6 class="mb-3">Predições de Exemplo (Primeiras ${yTest.length} amostras do conjunto de teste)</h6>
      <div class="table-responsive">
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th>#</th>
              <th>Valor Real (${targetCol})</th>
              <th>Valor Previsto</th>
              <th>Erro</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    yTest.forEach((real, idx) => {
      const pred = yPred[idx] || 0;
      const error = Math.abs(real - pred);
      const errorPercent = real !== 0 ? ((error / Math.abs(real)) * 100).toFixed(2) : 'N/A';
      
      tableHtml += `
        <tr>
          <td>${idx + 1}</td>
          <td>${real.toFixed(2)}</td>
          <td>${pred.toFixed(2)}</td>
          <td>${error.toFixed(2)} (${errorPercent}%)</td>
        </tr>
      `;
    });
    
    tableHtml += `
          </tbody>
        </table>
      </div>
    `;
    
    // Adiciona gráfico de comparação
    tableHtml += `
      <div class="mt-4">
        <h6 class="mb-3">Gráfico: Valores Reais vs Previstos</h6>
        <canvas id="regressionChart" height="100"></canvas>
      </div>
    `;
    
    container.innerHTML = tableHtml;
    
    // Cria gráfico
    setTimeout(() => {
      const ctx = document.getElementById('regressionChart');
      if (ctx) {
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: yTest.map((_, i) => `Amostra ${i + 1}`),
            datasets: [{
              label: 'Valor Real',
              data: yTest,
              borderColor: 'rgb(54, 162, 235)',
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              tension: 0.1
            }, {
              label: 'Valor Previsto',
              data: yPred,
              borderColor: 'rgb(255, 99, 132)',
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              tension: 0.1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: false
              }
            }
          }
        });
      }
    }, 100);
  }

  function updateClassificationResults(model) {
    const container = document.getElementById("resultsContainer");
    const yTest = model.y_test_sample || [];
    const yPred = model.y_pred_sample || [];
    const yProba = model.y_proba_sample || [];
    const targetCol = model.target_col || 'classe';
    const confusionMatrix = model.metrics?.confusion_matrix || [];
    
    if (yTest.length === 0 || yPred.length === 0) {
      container.innerHTML = '<p class="text-muted">Nenhum resultado de exemplo disponível.</p>';
      return;
    }
    
    // Cria tabela de predições
    let tableHtml = `
      <h6 class="mb-3">Predições de Exemplo (Primeiras ${yTest.length} amostras do conjunto de teste)</h6>
      <div class="table-responsive mb-4">
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th>#</th>
              <th>Classe Real (${targetCol})</th>
              <th>Classe Prevista</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    yTest.forEach((real, idx) => {
      const pred = yPred[idx];
      const isCorrect = real === pred;
      
      tableHtml += `
        <tr class="${isCorrect ? 'table-success' : 'table-danger'}">
          <td>${idx + 1}</td>
          <td>${real}</td>
          <td>${pred}</td>
          <td>${isCorrect ? 'Correto' : 'Incorreto'}</td>
        </tr>
      `;
    });
    
    tableHtml += `
          </tbody>
        </table>
      </div>
    `;
    
    // Adiciona matriz de confusão se disponível
    if (confusionMatrix && confusionMatrix.length > 0) {
      const classes = model.classes || [];
      tableHtml += `
        <div class="mt-4">
          <h6 class="mb-3">Matriz de Confusão</h6>
          <div class="table-responsive">
            <table class="table table-sm table-bordered text-center">
              <thead>
                <tr>
                  <th></th>
                  ${classes.map(c => `<th>Previsto: ${c}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
      `;
      
      confusionMatrix.forEach((row, i) => {
        tableHtml += `
          <tr>
            <th>Real: ${classes[i] || i}</th>
            ${row.map(cell => `<td>${cell}</td>`).join('')}
          </tr>
        `;
      });
      
      tableHtml += `
              </tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    container.innerHTML = tableHtml;
  }

  // Carrega features do modelo e cria formulário
  async function loadPredictionForm(modelId, modelType) {
    // Só permite predição individual para classificação
    if (modelType !== "classification") {
      const card = document.getElementById("individualPredictionCard");
      if (card) {
        card.style.display = "none";
      }
      return;
    }
    
    currentModelId = modelId;
    currentModelType = modelType;
    
    try {
      const featuresData = await API.getModelFeatures(modelId, modelType);
      modelFeatures = featuresData;
      
      const container = document.getElementById("predictionFormContainer");
      const card = document.getElementById("individualPredictionCard");
      
      if (!featuresData.all_features || featuresData.all_features.length === 0) {
        container.innerHTML = '<p class="text-danger">Nenhuma feature encontrada no modelo.</p>';
        card.style.display = "none";
        return;
      }
      
      // Cria formulário dinâmico
      let formHtml = '<div class="row">';
      
      featuresData.numeric_features.forEach(feature => {
        formHtml += `
          <div class="col-md-6 mb-3">
            <label for="pred_${feature}" class="form-label">${feature} <span class="text-muted">(numérico)</span></label>
            <input type="number" class="form-control" id="pred_${feature}" step="any" placeholder="Digite um valor numérico">
          </div>
        `;
      });
      
      featuresData.categorical_features.forEach(feature => {
        formHtml += `
          <div class="col-md-6 mb-3">
            <label for="pred_${feature}" class="form-label">${feature} <span class="text-muted">(categórico)</span></label>
            <input type="text" class="form-control" id="pred_${feature}" placeholder="Digite um valor categórico">
          </div>
        `;
      });
      
      formHtml += '</div>';
      container.innerHTML = formHtml;
      
      // Mostra o card
      card.style.display = "block";
      document.getElementById("predictBtn").disabled = false;
      
    } catch (error) {
      console.error("Erro ao carregar features:", error);
      API.showNotification("Erro ao carregar features do modelo: " + error.message, "error");
    }
  }

  // Faz a predição individual
  async function makePrediction() {
    if (!currentModelId || !currentModelType || !modelFeatures) {
      API.showNotification("Nenhum modelo carregado para predição.", "error");
      return;
    }
    
    // Garante que só funciona para classificação
    if (currentModelType !== "classification") {
      API.showNotification("Predição individual disponível apenas para classificação.", "error");
      return;
    }
    
    // Coleta valores do formulário
    const features = {};
    let hasEmptyFields = false;
    
    modelFeatures.all_features.forEach(feature => {
      const input = document.getElementById(`pred_${feature}`);
      if (input) {
        const value = input.value.trim();
        if (value === "") {
          hasEmptyFields = true;
        } else {
          // Converte para número se for feature numérica
          if (modelFeatures.numeric_features.includes(feature)) {
            // Substitui vírgula por ponto para aceitar formato brasileiro
            const normalizedValue = value.replace(',', '.');
            features[feature] = parseFloat(normalizedValue);
            if (isNaN(features[feature])) {
              hasEmptyFields = true;
            }
          } else {
            features[feature] = value;
          }
        }
      }
    });
    
    if (hasEmptyFields) {
      API.showNotification("Por favor, preencha todos os campos antes de fazer a predição.", "error");
      return;
    }
    
    try {
      document.getElementById("predictBtn").disabled = true;
      document.getElementById("predictBtn").innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Calculando...';
      
      const result = await API.predict(currentModelId, currentModelType, features);
      
      // Exibe resultado (apenas classificação)
      const resultContainer = document.getElementById("predictionResult");
      resultContainer.style.display = "block";
      
      if (currentModelType === "classification") {
        // Obtém as classes do modelo (precisa buscar do metadata)
        let classes = ['false', 'true']; // Default para binário
        if (result.classes) {
          classes = result.classes;
        } else {
          // Tenta obter do metadata se disponível
          try {
            const modelInfo = await API.getModel(currentModelId);
            if (modelInfo.metadata && modelInfo.metadata.classes) {
              classes = modelInfo.metadata.classes;
            }
          } catch (e) {
            console.warn("Não foi possível obter classes do modelo:", e);
          }
        }
        
        // Obtém predição e probabilidades
        const predictedLabel = result.y_pred_labels ? result.y_pred_labels[0] : result.predicted_labels[0];
        const predictedEncoded = result.y_pred_encoded ? result.y_pred_encoded[0] : result.predicted_labels[0];
        
        // Processa probabilidades
        let probabilities = null;
        if (result.y_proba !== undefined && result.y_proba !== null) {
          // y_proba pode ser um array simples (binário) ou matriz (multiclasse)
          if (Array.isArray(result.y_proba) && result.y_proba.length > 0) {
            if (Array.isArray(result.y_proba[0])) {
              // Matriz (multiclasse): pega primeira linha
              probabilities = result.y_proba[0];
            } else if (typeof result.y_proba[0] === 'number') {
              // Binário: y_proba contém apenas prob da classe 1
              const prob1 = result.y_proba[0];
              probabilities = [1 - prob1, prob1];
            } else {
              // Array de números
              probabilities = result.y_proba;
            }
          } else if (typeof result.y_proba === 'number') {
            // Valor único (probabilidade da classe 1)
            probabilities = [1 - result.y_proba, result.y_proba];
          }
        } else if (result.probabilities) {
          probabilities = Array.isArray(result.probabilities[0]) ? result.probabilities[0] : result.probabilities;
        }
        
        const maxProb = probabilities ? Math.max(...probabilities) : 0;
        const predictedClass = predictedLabel !== undefined ? predictedLabel : classes[predictedEncoded];
        
        let probHtml = '';
        if (probabilities && probabilities.length > 0) {
          probHtml = '<div class="mt-3"><strong>Probabilidades:</strong><ul class="list-group mt-2">';
          classes.forEach((cls, idx) => {
            const prob = probabilities[idx] || 0;
            probHtml += `
              <li class="list-group-item d-flex justify-content-between align-items-center">
                ${cls}
                <span class="badge ${idx === predictedEncoded ? 'bg-success' : 'bg-secondary'} rounded-pill">${(prob * 100).toFixed(2)}%</span>
              </li>
            `;
          });
          probHtml += '</ul></div>';
        }
        
        resultContainer.innerHTML = `
          <div class="alert alert-success">
            <h6><i class="fas fa-check-circle me-2"></i>Predição Realizada com Sucesso!</h6>
            <hr>
            <p class="mb-0"><strong>Classe Prevista:</strong> <span class="h4 text-success">${predictedClass}</span></p>
            ${probabilities ? `<p class="mb-0"><strong>Confiança:</strong> <span class="h5">${(maxProb * 100).toFixed(2)}%</span></p>` : ''}
            ${probHtml}
            <small class="text-muted d-block mt-2">Modelo: ${currentModelId}</small>
          </div>
        `;
      }
      
    } catch (error) {
      console.error("Erro ao fazer predição:", error);
      let errorMessage = "Erro ao fazer predição: ";
      if (error.message) {
        errorMessage += error.message;
      } else if (error.response) {
        // Se for erro HTTP, tenta obter mensagem do servidor
        error.response.json().then(data => {
          API.showNotification(errorMessage + (data.error || "Erro desconhecido"), "error");
        }).catch(() => {
          API.showNotification(errorMessage + "Erro ao processar resposta do servidor", "error");
        });
      } else {
        errorMessage += "Erro desconhecido. Verifique o console para mais detalhes.";
      }
      API.showNotification(errorMessage, "error");
      document.getElementById("predictionResult").style.display = "none";
    } finally {
      document.getElementById("predictBtn").disabled = false;
      document.getElementById("predictBtn").innerHTML = '<i class="fas fa-magic me-2"></i>Fazer Predição';
    }
  }

  // Inicialização
  document.addEventListener('DOMContentLoaded', function() {
    loadColumns();
    loadModels();
    updateAlgorithms(); // Inicializa algoritmos corretos e habilita o select de variável alvo
    // Habilita o select após carregar
    document.getElementById("targetVariable").disabled = false;
  });
</script>
{% endblock %}
